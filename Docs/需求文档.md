# DuiDuiMao 功能需求文档 v2

## 一、用户端功能

### 1.1 登录模块

- LinuxDo Connect OAuth2 登录
- 登录后自动创建/更新本地用户记录
- JWT Token 管理（签发、刷新、过期处理）
- 登出功能

### 1.2 首页/额度选择

- 展示可选的额度档位列表
- 每个档位显示：额度值、所需等级、库存数量、每人限购
- 根据用户 `trust_level` 显示可购买状态
- **用户自选额度**：选择档位 → 选择购买数量

### 1.3 购买/兑换流程

```
选择档位 → 选择数量 → 确认订单 → 创建订单 → 扣减积分(如有) → 发放CDK → 完成
```

- 创建订单时锁定CDK库存
- 支付成功 → 订单完成，CDK发放给用户
- 支付失败/超时 → 订单关闭，释放库存
- 支持一键复制CDK

### 1.4 我的订单

- 查看历史订单列表
- 订单状态：待支付、已完成、已取消、已失败
- 点击订单查看详情：
  - 订单号、创建时间、档位、数量、总额度
  - 支付状态、支付时间
  - CDK列表（已完成订单可查看/复制）

---

## 二、管理端功能

### 2.1 管理员认证

- 通过配置文件指定管理员（LinuxDo用户ID或用户名）
- 管理端入口需要管理员身份校验

### 2.2 档位管理

- **新增/编辑/删除档位**
  - 名称（如：小份、中份、大份）
  - 额度值（10、50、100...）
  - 所需信任等级
  - 每人每日限购数量
  - 是否启用

### 2.3 CDK管理

- **批量导入CDK**
  - 选择导入到哪个档位
  - 文本框粘贴，一行一个
  - 导入后自动标记为"未兑换"

- **CDK列表**
  - 查看所有CDK及状态
  - 筛选：按档位、按状态（未兑换/已兑换/已锁定/已作废）
  - 支持手动作废CDK

### 2.4 订单管理

- 查看**所有订单**（包括失败的）
- 订单状态筛选：全部、待支付、已完成、已取消、已失败
- 按用户、按档位、按时间范围筛选
- 订单详情：用户信息、支付信息、CDK信息
- 导出功能（可选）

### 2.5 系统设置

- 全局开关（暂停购买功能）
- 公告设置（首页显示）
- 订单超时时间设置

---

## 三、数据模型

### 3.1 用户表 (users)

| 字段 | 类型 | 说明 |
|------|------|------|
| id | int | 主键 |
| linux_do_id | int | LinuxDo用户ID（唯一） |
| username | string | 用户名 |
| name | string | 昵称 |
| trust_level | int | 信任等级 |
| is_admin | bool | 是否管理员 |
| created_at | datetime | 创建时间 |
| updated_at | datetime | 更新时间 |

### 3.2 额度档位表 (tiers)

| 字段 | 类型 | 说明 |
|------|------|------|
| id | int | 主键 |
| name | string | 档位名称 |
| quota | int | 额度值 |
| required_level | int | 所需信任等级 |
| daily_limit | int | 每人每日限购（0=不限） |
| stock | int | 当前库存 |
| is_active | bool | 是否启用 |
| sort_order | int | 排序权重 |
| created_at | datetime | 创建时间 |
| updated_at | datetime | 更新时间 |

### 3.3 CDK表 (cdks)

| 字段 | 类型 | 说明 |
|------|------|------|
| id | int | 主键 |
| tier_id | int | 所属档位 |
| code | string | CDK内容（加密存储） |
| status | int | 0未兑换 1已锁定 2已兑换 3已作废 |
| order_id | int | 关联订单ID |
| created_at | datetime | 导入时间 |
| updated_at | datetime | 更新时间 |

### 3.4 订单表 (orders)

| 字段 | 类型 | 说明 |
|------|------|------|
| id | int | 主键 |
| order_no | string | 订单号（唯一） |
| user_id | int | 用户ID |
| tier_id | int | 档位ID |
| quantity | int | 购买数量 |
| total_quota | int | 总额度 |
| status | int | 0待支付 1已完成 2已取消 3已失败 |
| created_at | datetime | 创建时间 |
| paid_at | datetime | 支付时间 |
| expired_at | datetime | 过期时间 |

### 3.5 支付记录表 (payments)

| 字段 | 类型 | 说明 |
|------|------|------|
| id | int | 主键 |
| order_id | int | 关联订单ID |
| user_id | int | 用户ID |
| amount | int | 支付金额/积分 |
| payment_type | string | 支付方式（points/free） |
| status | int | 0处理中 1成功 2失败 |
| transaction_id | string | 第三方交易号（如有） |
| fail_reason | string | 失败原因 |
| created_at | datetime | 创建时间 |
| finished_at | datetime | 完成时间 |

---

## 四、接口规划

### 4.1 认证接口

```
GET    /api/auth/login              # 跳转LinuxDo登录
GET    /api/auth/callback           # OAuth回调
POST   /api/auth/logout             # 登出
GET    /api/auth/me                 # 获取当前用户信息
```

### 4.2 用户端接口

```
GET    /api/tiers                   # 获取档位列表
GET    /api/tiers/:id/stock         # 获取档位库存

POST   /api/orders                  # 创建订单
GET    /api/orders                  # 我的订单列表
GET    /api/orders/:order_no        # 订单详情
POST   /api/orders/:order_no/cancel # 取消订单
GET    /api/orders/:order_no/cdks   # 获取订单CDK（已完成订单）
```

### 4.3 管理端接口

```
# 档位管理
GET    /api/admin/tiers             # 档位列表
POST   /api/admin/tiers             # 新增档位
PUT    /api/admin/tiers/:id         # 编辑档位
DELETE /api/admin/tiers/:id         # 删除档位

# CDK管理
GET    /api/admin/cdks              # CDK列表
POST   /api/admin/cdks/import       # 批量导入CDK
PUT    /api/admin/cdks/:id/revoke   # 作废CDK

# 订单管理
GET    /api/admin/orders            # 全部订单列表
GET    /api/admin/orders/:order_no  # 订单详情
GET    /api/admin/orders/export     # 导出订单（可选）

# 系统设置
GET    /api/admin/settings          # 获取设置
PUT    /api/admin/settings          # 更新设置
```

---

## 五、订单状态流转

```
┌─────────────┐
│   创建订单   │
│  (待支付)    │
└──────┬──────┘
       │
       ▼
   ┌───────┐
   │ 支付中 │
   └───┬───┘
       │
  ┌────┴────┐
  ▼         ▼
成功       失败/超时
  │         │
  ▼         ▼
┌─────┐  ┌──────┐
│已完成│  │已失败│
│发放CDK│ │释放库存│
└─────┘  └──────┘
```

---

## 六、安全要点

1. **OAuth state 校验** - 防止CSRF攻击
2. **JWT 签名验证** - 防止Token伪造
3. **订单创建防重** - 同一用户短时间内不能重复创建
4. **库存扣减原子操作** - 防止超卖
5. **CDK发放事务** - 订单状态更新和CDK绑定要原子操作
6. **限购校验后端必做** - 不能只靠前端
7. **管理接口鉴权** - 必须校验管理员身份
8. **CDK内容加密存储** - 防止数据库泄露
9. **订单超时自动关闭** - 定时任务释放锁定的CDK

---

## 七、配置项

```yaml
server:
  port: 8080
  jwt_secret: "your_jwt_secret"

database:
  driver: "sqlite"  # sqlite 或 postgres
  sqlite:
    path: "./data/duiuimao.db"
  postgres:
    host: "localhost"
    port: 5432
    user: "duiuimao"
    password: "your_password"
    dbname: "duiuimao"
    sslmode: "disable"

oauth:
  client_id: "your_client_id"
  client_secret: "your_client_secret"
  redirect_uri: "https://your-domain.com/api/auth/callback"

order:
  expire_minutes: 15  # 订单超时时间

admin:
  user_ids: [124, 456]  # 管理员的LinuxDo用户ID
```